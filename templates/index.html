<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåì</button>

    <div class="container">
        <h1>ü§ñ {{ title }}</h1>
        <p class="subtitle">{{ subtitle }}</p>

        <!-- Question Input Section -->
        <div class="form-section">
            <h3>‚ùì Question</h3>
            <div class="input-group">
                <textarea id="question" placeholder="Enter the question you asked to all GenAI tools..." rows="3" required></textarea>
            </div>
        </div>

        <!-- Provider Selection -->
        <div class="form-section">
            <h3>üîß Evaluation Provider</h3>
            <div class="input-group">
                <select id="provider" required>
                    <option value="gemini">üü¢ Gemini (Free)</option>
                    <option value="groq">üü° Groq (Free)</option>
                    <option value="anthropic">üîµ Claude (Paid)</option>
                </select>
            </div>
        </div>

        <!-- GenAI Responses Section -->
        <div class="form-section">
            <h3>ü§ñ GenAI Tool Responses</h3>
            <div id="responsesContainer">
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="ChatGPT" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from ChatGPT..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Kimi" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Kimi..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="DeepSeek" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from DeepSeek..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Gemini" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Gemini..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Qwen" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Qwen..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Mistral" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Mistral..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Claude" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Claude..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Grok" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Grok..." rows="4" required></textarea>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addResponse()">‚ûï Add Another Tool Response</button>
        </div>

        <!-- Evaluate Button -->
        <div class="form-section">
            <button id="evaluateBtn" class="control-btn" onclick="evaluateResponses()">üöÄ Evaluate Responses</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Evaluating responses... This may take a moment.</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="visualization-section" style="display: none;">
            <h3>üìä Evaluation Results</h3>
            <div id="resultsTable"></div>
            <div id="detailedResults"></div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        // Load theme preference
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
        }

        function addResponse() {
            const container = document.getElementById('responsesContainer');
            const responseItem = document.createElement('div');
            responseItem.className = 'response-item';
            responseItem.innerHTML = `
                <div class="input-row">
                    <input type="text" class="tool-name" placeholder="Tool name (e.g., Perplexity)" required>
                    <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                </div>
                <textarea class="tool-response" placeholder="Paste the response from this tool..." rows="4" required></textarea>
            `;
            container.appendChild(responseItem);
        }

        function removeResponse(button) {
            const responseItem = button.closest('.response-item');
            const container = document.getElementById('responsesContainer');
            if (container.children.length > 1) {
                responseItem.remove();
            } else {
                showStatus('At least one response is required', 'error');
            }
        }

        async function evaluateResponses() {
            const question = document.getElementById('question').value.trim();
            const provider = document.getElementById('provider').value;
            
            if (!question) {
                showStatus('Please enter a question', 'error');
                return;
            }

            // Collect all responses
            const responses = {};
            const responseItems = document.querySelectorAll('.response-item');
            
            for (let item of responseItems) {
                const toolName = item.querySelector('.tool-name').value.trim();
                const toolResponse = item.querySelector('.tool-response').value.trim();
                
                if (!toolName || !toolResponse) {
                    showStatus('Please fill in all tool names and responses', 'error');
                    return;
                }
                
                responses[toolName] = toolResponse;
            }

            if (Object.keys(responses).length < 2) {
                showStatus('Please add at least 2 tool responses for comparison', 'error');
                return;
            }

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('evaluateBtn').disabled = true;
            document.getElementById('resultsSection').style.display = 'none';

            try {
                const response = await fetch('/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        responses: responses,
                        provider: provider
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                    showStatus('Evaluation completed successfully!', 'success');
                } else {
                    throw new Error(data.detail || 'Evaluation failed');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('evaluateBtn').disabled = false;
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsTable = document.getElementById('resultsTable');
            const detailedResults = document.getElementById('detailedResults');

            // Sort table data by Overall Score in descending order
            const sortedTableData = data.table_data.sort((a, b) => {
                return b['Overall Score'] - a['Overall Score'];
            });

            // Create results table
            let tableHTML = `
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Tool</th>
                                <th>Truthfulness</th>
                                <th>Creativity</th>
                                <th>Coherence & Reasoning</th>
                                <th>Utility/Actionability</th>
                                <th>Overall Score</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedTableData.forEach((row, index) => {
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                const rowClass = index === 0 ? 'winner-row' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td><strong>${rankEmoji}</strong></td>
                        <td><strong>${row.Tool}</strong></td>
                        <td>${row.Truthfulness}/10</td>
                        <td>${row.Creativity}/10</td>
                        <td>${row['Coherence & Reasoning']}/10</td>
                        <td>${row['Utility/Actionability']}/10</td>
                        <td><strong>${row['Overall Score']}/10</strong></td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsTable.innerHTML = tableHTML;

            // Create detailed results (also sorted by overall score)
            const evaluation = data.evaluation_results;
            const sortedEvaluations = evaluation.evaluations.sort((a, b) => {
                return b.overall_score - a.overall_score;
            });

            let detailedHTML = `
                <div class="detailed-results">
                    <div class="winner-section">
                        <h4>üèÜ Winner: ${evaluation.winner}</h4>
                        <p>${evaluation.winner_reasoning}</p>
                        <p><strong>Ranking:</strong> ${evaluation.ranking.join(' > ')}</p>
                    </div>
            `;

            sortedEvaluations.forEach((eval, index) => {
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                const winnerClass = index === 0 ? 'winner-details' : '';
                
                detailedHTML += `
                    <div class="tool-details ${winnerClass}">
                        <h4>${rankEmoji} ${eval.tool} (${eval.overall_score}/10)</h4>
                        <div class="metric-details">
                            <p><strong>Truthfulness (${eval.truthfulness.score}/10):</strong> ${eval.truthfulness.reasoning}</p>
                            <p><strong>Creativity (${eval.creativity.score}/10):</strong> ${eval.creativity.reasoning}</p>
                            <p><strong>Coherence (${eval.coherence.score}/10):</strong> ${eval.coherence.reasoning}</p>
                            <p><strong>Utility (${eval.utility.score}/10):</strong> ${eval.utility.reasoning}</p>
                            ${eval.notes ? `<p><strong>Notes:</strong> ${eval.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            });

            detailedHTML += '</div>';
            detailedResults.innerHTML = detailedHTML;

            resultsSection.style.display = 'block';
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Default response items are already in the HTML
        });
    </script>
</body>

</html>