<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Analytics -->
    {% include 'sub/google_analytics.html' %}
</head>

<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåì</button>

    <div class="container">
        <div class="header-section">
            <img src="/static/images/slogo2.png" alt="Scrutinium Logo" class="logo">
            <h1>{{ title }}</h1>
            <div class="nav-links">
                <a href="/archive" class="nav-link">üìö Archive</a>
                <a href="/archive-heatmap" class="nav-link">üìä Heatmap</a>
            </div>
        </div>
        <p class="subtitle">{{ subtitle }}</p>

        <!-- Question Input Section -->
        <div class="form-section">
            <h3>‚ùì Question</h3>
            <div class="input-group">
                <textarea id="question" placeholder="Enter the question you asked to all GenAI tools..." rows="3" required></textarea>
            </div>
        </div>

        <!-- Provider Selection -->
        <div class="form-section">
            <h3>üîß Evaluation Provider</h3>
            <div class="input-group">
                <select id="provider" required onchange="toggleApiKeyInput()">
                    <option value="ollama">üü† Ollama (Local)</option>
                    <option value="gemini">üü¢ Gemini (Free)</option>
                    <option value="groq">üü° Groq (Free)</option>
                    <option value="anthropic">üîµ Claude (Paid)</option>
                </select>
            </div>
            
            <!-- Gemini API Key Input (shown when Gemini is selected) -->
            <div id="geminiKeySection" class="api-key-section">
                <div class="input-group">
                    <label for="geminiApiKey">üîë Gemini API Key (Optional)</label>
                    <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key (optional)">
                    <small class="help-text">
                        If you don't provide a key, we'll use our default key (limited usage). 
                        <a href="https://ai.google.dev/" target="_blank">Get your free Gemini API key</a>
                    </small>
                </div>
                <div class="key-status" id="keyStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- Gemini Limit Modal -->
        <div id="geminiLimitModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ö†Ô∏è Gemini Model Limit Reached</h3>
                    <span class="close" onclick="closeGeminiModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Gemini model limit reached, visit us back next time.</p>
                    <p>You can provide your own Gemini API key to continue using the service:</p>
                    <div class="input-group">
                        <label for="modalGeminiKey">üîë Your Gemini API Key</label>
                        <input type="password" id="modalGeminiKey" placeholder="Enter your Gemini API key">
                        <small class="help-text">
                            <a href="https://ai.google.dev/" target="_blank">Get your free Gemini API key here</a>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeGeminiModal()" class="secondary-btn">Cancel</button>
                    <button onclick="retryWithUserKey()" class="primary-btn">Retry with My Key</button>
                </div>
            </div>
        </div>

        <!-- GenAI Responses Section -->
        <div class="form-section">
            <h3>ü§ñ GenAI Tool Responses</h3>
            <div id="responsesContainer">
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="ChatGPT" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from ChatGPT..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Kimi" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Kimi..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="DeepSeek" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from DeepSeek..." rows="4" required></textarea>
                </div>
                <!-- <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Gemini" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Gemini..." rows="4" required></textarea>
                </div> -->
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Qwen" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Qwen..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Mistral" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Mistral..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Claude" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Claude..." rows="4" required></textarea>
                </div>
                <div class="response-item">
                    <div class="input-row">
                        <input type="text" class="tool-name" value="Grok" required>
                        <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                    </div>
                    <textarea class="tool-response" placeholder="Paste the response from Grok..." rows="4" required></textarea>
                </div>
            </div>
            <button type="button" class="add-btn" onclick="addResponse()">‚ûï Add Another Tool Response</button>
        </div>

        <!-- Evaluate Button -->
        <div class="form-section">
            <button id="evaluateBtn" class="control-btn" onclick="evaluateResponses()">üöÄ Evaluate Responses</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>Evaluating responses... This may take a moment.</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="visualization-section" style="display: none;">
            <h3>üìä Evaluation Results</h3>
            <div id="resultsTable"></div>
            <div id="detailedResults"></div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        // Load theme preference
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
        }

        function addResponse() {
            const container = document.getElementById('responsesContainer');
            const responseItem = document.createElement('div');
            responseItem.className = 'response-item';
            responseItem.innerHTML = `
                <div class="input-row">
                    <input type="text" class="tool-name" placeholder="Tool name (e.g., Perplexity)" required>
                    <button type="button" class="remove-btn" onclick="removeResponse(this)">‚ùå</button>
                </div>
                <textarea class="tool-response" placeholder="Paste the response from this tool..." rows="4" required></textarea>
            `;
            container.appendChild(responseItem);
        }

        function removeResponse(button) {
            const responseItem = button.closest('.response-item');
            const container = document.getElementById('responsesContainer');
            if (container.children.length > 1) {
                responseItem.remove();
            } else {
                showStatus('At least one response is required', 'error');
            }
        }

        function toggleApiKeyInput() {
            const provider = document.getElementById('provider').value;
            const geminiKeySection = document.getElementById('geminiKeySection');
            
            if (provider === 'gemini') {
                geminiKeySection.style.display = 'block';
            } else {
                geminiKeySection.style.display = 'none';
            }
        }

        function closeGeminiModal() {
            document.getElementById('geminiLimitModal').style.display = 'none';
        }

        function retryWithUserKey() {
            const userKey = document.getElementById('modalGeminiKey').value.trim();
            if (!userKey) {
                showStatus('Please enter your Gemini API key', 'error');
                return;
            }
            
            // Set the key in the main form and retry evaluation
            document.getElementById('geminiApiKey').value = userKey;
            closeGeminiModal();
            evaluateResponses();
        }

        async function clearApiKey() {
            try {
                await fetch('/clear-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                document.getElementById('geminiApiKey').value = '';
                showStatus('API key cleared from session', 'success');
            } catch (error) {
                console.error('Error clearing API key:', error);
            }
        }

        async function evaluateResponses() {
            const question = document.getElementById('question').value.trim();
            const provider = document.getElementById('provider').value;
            const userApiKey = document.getElementById('geminiApiKey').value.trim();
            
            if (!question) {
                showStatus('Please enter a question', 'error');
                return;
            }

            // Collect all responses
            const responses = {};
            const responseItems = document.querySelectorAll('.response-item');
            
            for (let item of responseItems) {
                const toolName = item.querySelector('.tool-name').value.trim();
                const toolResponse = item.querySelector('.tool-response').value.trim();
                
                if (!toolName || !toolResponse) {
                    showStatus('Please fill in all tool names and responses', 'error');
                    return;
                }
                
                responses[toolName] = toolResponse;
            }

            if (Object.keys(responses).length < 2) {
                showStatus('Please add at least 2 tool responses for comparison', 'error');
                return;
            }

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('evaluateBtn').disabled = true;
            document.getElementById('resultsSection').style.display = 'none';

            try {
                const requestBody = {
                    question: question,
                    responses: responses,
                    provider: provider
                };

                // Add user API key if provided
                if (userApiKey) {
                    requestBody.user_api_key = userApiKey;
                }

                const response = await fetch('/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                console.log('Response received:', data);
                console.log('Data.success:', data.success);
                console.log('Data.table_data:', data.table_data);
                console.log('Data.evaluation_results:', data.evaluation_results);

                if (data.success) {
                    console.log('Evaluation successful, displaying results...');
                    console.log('About to call displayResults...');
                    displayResults(data);
                    console.log('displayResults called');
                    showStatus('Evaluation completed successfully!', 'success');
                } else if (data.gemini_limit_reached) {
                    // Show Gemini limit modal
                    document.getElementById('geminiLimitModal').style.display = 'block';
                } else {
                    throw new Error(data.detail || 'Evaluation failed');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('evaluateBtn').disabled = false;
            }
        }

        // Simple markdown to HTML converter for basic formatting
        function markdownToHtml(text) {
            if (!text) return '';
            
            return text
                // Remove image references like ![Image](url) or ![alt text](url)
                .replace(/!\[.*?\]\(.*?\)/g, '')
                // Bold text **text** or __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // Italic text *text* or _text_
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // Code blocks ```code```
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code `code`
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks
                .replace(/\n/g, '<br>')
                // Lists (basic support)
                .replace(/^\* (.*$)/gm, '<li>$1</li>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                // Wrap consecutive <li> elements in <ul>
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>');
        }

        function displayResults(data) {
            try {
                console.log('displayResults called with data:', data);
                
                const resultsSection = document.getElementById('resultsSection');
                const resultsTable = document.getElementById('resultsTable');
                const detailedResults = document.getElementById('detailedResults');
                
                console.log('Elements found:');
                console.log('- resultsSection:', resultsSection);
                console.log('- resultsTable:', resultsTable);
                console.log('- detailedResults:', detailedResults);

                // Check if table_data exists and has content
                if (!data.table_data || data.table_data.length === 0) {
                    console.log('No table data found:', data.table_data);
                    showStatus('No results data received', 'error');
                    return;
                }
                
                console.log('Table data found:', data.table_data.length, 'items');
                console.log('Table data content:', data.table_data);

            // Display judge's answer if available and enabled
            let judgeAnswerHTML = '';
            if (data.show_judge_answer && data.evaluation_results && data.evaluation_results.judge_answer) {
                judgeAnswerHTML = `
                    <div class="judge-answer-section">
                        <h4>ü§ñ Judge's Answer</h4>
                        <div class="judge-answer-text">${markdownToHtml(data.evaluation_results.judge_answer)}</div>
                    </div>
                `;
            }

            // Sort table data by Overall Score in descending order
            const sortedTableData = data.table_data.sort((a, b) => {
                return b['Overall Score'] - a['Overall Score'];
            });

            // Create share link section if available
            let shareHTML = '';
            if (data.evaluation_results.share_url) {
                // Use the share_url as-is if it's a full URL, otherwise prepend origin
                const shareUrl = data.evaluation_results.share_url.startsWith('http') 
                    ? data.evaluation_results.share_url 
                    : window.location.origin + data.evaluation_results.share_url;
                    
                shareHTML = `
                    <div class="share-section">
                        <h4>üîó Share Results</h4>
                        <div class="share-link-container">
                            <input type="text" id="shareUrl" value="${shareUrl}" readonly>
                            <button onclick="copyShareUrl()" class="copy-btn">üìã Copy Link</button>
                            <a href="${shareUrl}" target="_blank" class="view-btn">üëÅÔ∏è View Shared Page</a>
                        </div>
                        <p class="share-note">Share this link to let others view these evaluation results</p>
                    </div>
                `;
            }

            // Create results table
            let tableHTML = shareHTML + judgeAnswerHTML + `
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Tool</th>
                                <th>Truthfulness</th>
                                <th>Creativity</th>
                                <th>Coherence & Reasoning</th>
                                <th>Utility/Actionability</th>
                                <th>Overall Score</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedTableData.forEach((row, index) => {
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                const rowClass = index === 0 ? 'winner-row' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td><strong>${rankEmoji}</strong></td>
                        <td><strong>${row.Tool}</strong></td>
                        <td>${parseFloat(row.Truthfulness).toFixed(3)}/10</td>
                        <td>${parseFloat(row.Creativity).toFixed(3)}/10</td>
                        <td>${parseFloat(row['Coherence & Reasoning']).toFixed(3)}/10</td>
                        <td>${parseFloat(row['Utility/Actionability']).toFixed(3)}/10</td>
                        <td><strong>${parseFloat(row['Overall Score']).toFixed(3)}/10</strong></td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsTable.innerHTML = tableHTML;

            // Create detailed results (also sorted by overall score)
            const evaluation = data.evaluation_results;
            console.log('Evaluation object:', evaluation);
            console.log('Evaluations array:', evaluation.evaluations);
            console.log('Ranking:', evaluation.ranking);
            
            const evaluations = evaluation.evaluations || [];
            const sortedEvaluations = evaluations.sort((a, b) => {
                return (b.overall_score || 0) - (a.overall_score || 0);
            });

            let detailedHTML = `
                <div class="detailed-results">
                    <div class="winner-section">
                        <h4>üèÜ Winner: ${evaluation.winner || 'Unknown'}</h4>
                        <div>${markdownToHtml(evaluation.winner_reasoning || 'No reasoning provided')}</div>
                        ${evaluation.ranking && evaluation.ranking.length > 0 ? 
                            `<p><strong>Ranking:</strong> ${evaluation.ranking.join(' > ')}</p>` : 
                            ''
                        }
                    </div>
            `;

            sortedEvaluations.forEach((eval, index) => {
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                const winnerClass = index === 0 ? 'winner-details' : '';
                
                detailedHTML += `
                    <div class="tool-details ${winnerClass}">
                        <h4>${rankEmoji} ${eval.tool || 'Unknown'} (${parseFloat(eval.overall_score || 0).toFixed(3)}/10)</h4>
                        <div class="metric-details">
                            <p><strong>Truthfulness (${parseFloat((eval.truthfulness && eval.truthfulness.score) || 0).toFixed(3)}/10):</strong> ${markdownToHtml((eval.truthfulness && eval.truthfulness.reasoning) || 'No reasoning provided')}</p>
                            <p><strong>Creativity (${parseFloat((eval.creativity && eval.creativity.score) || 0).toFixed(3)}/10):</strong> ${markdownToHtml((eval.creativity && eval.creativity.reasoning) || 'No reasoning provided')}</p>
                            <p><strong>Coherence (${parseFloat((eval.coherence && eval.coherence.score) || 0).toFixed(3)}/10):</strong> ${markdownToHtml((eval.coherence && eval.coherence.reasoning) || 'No reasoning provided')}</p>
                            <p><strong>Utility (${parseFloat((eval.utility && eval.utility.score) || 0).toFixed(3)}/10):</strong> ${markdownToHtml((eval.utility && eval.utility.reasoning) || 'No reasoning provided')}</p>
                            ${eval.notes ? `<p><strong>Notes:</strong> ${markdownToHtml(eval.notes)}</p>` : ''}
                        </div>
                    </div>
                `;
            });

            detailedHTML += '</div>';
            detailedResults.innerHTML = detailedHTML;

            console.log('About to show results section...');
            console.log('Results section element:', resultsSection);
            resultsSection.style.display = 'block';
            console.log('Results section display set to:', resultsSection.style.display);
            
            // Scroll to results section
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            console.log('displayResults completed successfully');
            
            } catch (error) {
                console.error('Error in displayResults:', error);
                showStatus('Error displaying results: ' + error.message, 'error');
            }
        }

        function copyShareUrl() {
            const shareUrlInput = document.getElementById('shareUrl');
            const url = shareUrlInput.value;
            console.log('Attempting to copy URL:', url);
            
            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(function() {
                    console.log('Clipboard API success');
                    showCopySuccess();
                }).catch(function(err) {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                console.log('Clipboard API not available, using fallback');
                fallbackCopyTextToClipboard(url);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                console.log('Fallback copy result:', successful);
                if (successful) {
                    showCopySuccess();
                } else {
                    showCopyError(text);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showCopyError(text);
            }
            
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            const originalBackground = copyBtn.style.backgroundColor || '';
            
            copyBtn.textContent = '‚úÖ Copied!';
            copyBtn.style.backgroundColor = '#27ae60';
            
            setTimeout(function() {
                copyBtn.textContent = originalText;
                copyBtn.style.backgroundColor = originalBackground;
            }, 2000);
        }

        function showCopyError(url) {
            alert('Failed to copy automatically. Please copy this link manually:\n\n' + url);
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize API key section visibility
            toggleApiKeyInput();
            
            // Close modal when clicking outside of it
            window.onclick = function(event) {
                const modal = document.getElementById('geminiLimitModal');
                if (event.target === modal) {
                    closeGeminiModal();
                }
            }
        });
    </script>

    {% include 'sub/footer.html' %}
</body>

</html>